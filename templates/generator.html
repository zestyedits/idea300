<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Session Generator — Expert Session Architect</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .generator-layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 24px;
            margin-top: 24px;
        }
        
        @media (max-width: 1024px) {
            .generator-layout {
                grid-template-columns: 1fr;
            }
        }
        
        .form-section {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .sidebar-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #e9ecef;
            height: fit-content;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 15px;
            transition: border-color 0.2s;
            font-family: inherit;
        }
        
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #5469d4;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        @media (max-width: 640px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        .tone-selector {
            display: flex;
            gap: 8px;
            background: #f1f3f5;
            padding: 4px;
            border-radius: 8px;
        }
        
        .tone-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            color: #495057;
            transition: all 0.2s;
        }
        
        .tone-btn:hover {
            background: rgba(84, 105, 212, 0.1);
        }
        
        .tone-btn[aria-pressed="true"] {
            background: white;
            color: #5469d4;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .generate-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #5469d4 0%, #4053c4 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 8px;
        }
        
        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(84, 105, 212, 0.3);
        }
        
        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .help-text {
            color: #6c757d;
            font-size: 13px;
            margin-top: 8px;
            line-height: 1.5;
        }
        
        .template-list {
            list-style: none;
            padding: 0;
            margin: 16px 0 0 0;
        }
        
        .template-item {
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .template-item:hover {
            border-color: #5469d4;
            box-shadow: 0 2px 8px rgba(84, 105, 212, 0.15);
        }
        
        .template-topic {
            font-weight: 500;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .template-modality {
            color: #5469d4;
            font-size: 12px;
            font-weight: 600;
            margin-top: 4px;
        }
        
        .result-section {
            margin-top: 32px;
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        
        .toolbar {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f1f3f5;
        }
        
        .toolbar-btn {
            padding: 10px 20px;
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            color: #495057;
            transition: all 0.2s;
        }
        
        .toolbar-btn:hover {
            border-color: #5469d4;
            color: #5469d4;
        }
        
        .plan-content {
            color: #2c3e50;
            line-height: 1.8;
        }
        
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .sidebar-title {
            font-size: 16px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 4px;
        }
        
        .sidebar-subtitle {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 16px;
        }
    </style>
</head>

<body>
  <header aria-label="Primary">
    <div class="nav wrap">
      <a href="/dashboard" class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 2l2.2 5.6L20 9l-5.2 3.6L16 18l-4-2.7L8 18l1.2-5.4L4 9l5.8-1.4L12 2z" fill="white" opacity=".9"/></svg>
        </div>
        <span>Session Architect</span>
      </a>
      <nav class="nav-links">
        <a href="/dashboard">Dashboard</a>
        <a href="/generator" style="color:var(--brand2)">Generator</a>
        <a href="/history">History</a>
        <a href="/billing">Billing</a>
        <a href="/faq">FAQ</a>
        <a href="/logout" class="secondary-btn">Log Out</a>
      </nav>
    </div>
  </header>

  <main class="wrap" role="main">
    <header>
      <h1>Session Generator</h1>
      <p class="muted" style="margin-top:-.35rem">Create structured, evidence-based therapy plans in seconds.</p>
      <div class="accent" aria-hidden="true"></div>
    </header>

    <div class="generator-layout">
      <div class="form-section">
        <form id="generator-form" method="POST" action="/generator">
          <input type="hidden" name="tone" id="tone" value="balanced" />

          <div class="form-group">
            <label for="topic">Client Focus / Presenting Concern</label>
            <textarea id="topic" name="topic" rows="4"
              placeholder="Example: Adult client experiencing panic attacks in crowded spaces, seeking help with exposure strategies (telehealth format)" required></textarea>
            <div class="help-text">Be specific about age group, setting, and key symptoms or challenges.</div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="modality">Therapeutic Modality</label>
              <select id="modality" name="modality" required>
                <option value="" disabled selected>Select a modality</option>
                <optgroup label="Cognitive-Behavioral">
                  <option value="CBT">CBT (Cognitive Behavioral Therapy)</option>
                  <option value="DBT">DBT (Dialectical Behavior Therapy)</option>
                  <option value="ACT">ACT (Acceptance & Commitment Therapy)</option>
                  <option value="REBT">REBT (Rational Emotive Behavior Therapy)</option>
                </optgroup>
                <optgroup label="Psychodynamic">
                  <option value="Psychodynamic">Psychodynamic Therapy</option>
                  <option value="Psychoanalytic">Psychoanalytic Therapy</option>
                </optgroup>
                <optgroup label="Humanistic">
                  <option value="Person-Centered">Person-Centered Therapy</option>
                  <option value="Gestalt">Gestalt Therapy</option>
                  <option value="Existential">Existential Therapy</option>
                </optgroup>
                <optgroup label="Systemic">
                  <option value="Family Systems">Family Systems Therapy</option>
                  <option value="Structural">Structural Family Therapy</option>
                  <option value="Narrative">Narrative Therapy</option>
                </optgroup>
                <optgroup label="Trauma-Focused">
                  <option value="EMDR">EMDR (Eye Movement Desensitization)</option>
                  <option value="ART">ART (Accelerated Resolution Therapy)</option>
                  <option value="TF-CBT">TF-CBT (Trauma-Focused CBT)</option>
                  <option value="Somatic">Somatic Experiencing</option>
                </optgroup>
                <optgroup label="Solution & Strength-Based">
                  <option value="SFBT">SFBT (Solution-Focused Brief Therapy)</option>
                  <option value="Motivational">Motivational Interviewing</option>
                </optgroup>
                <optgroup label="Integrative & Contemporary">
                  <option value="IFS">IFS (Internal Family Systems)</option>
                  <option value="EFT">EFT (Emotion-Focused Therapy)</option>
                  <option value="Schema">Schema Therapy</option>
                  <option value="Integrative">Integrative Therapy</option>
                </optgroup>
              </select>
            </div>

            <div class="form-group">
              <label>Tone & Style</label>
              <div class="tone-selector" role="group" aria-label="Output tone">
                <button type="button" class="tone-btn" data-tone="creative" aria-pressed="false">Creative</button>
                <button type="button" class="tone-btn" data-tone="balanced" aria-pressed="true">Balanced</button>
                <button type="button" class="tone-btn" data-tone="professional" aria-pressed="false">Professional</button>
              </div>
            </div>
          </div>

          <div class="form-group" style="margin-top: 24px;">
            <button id="generate-btn" class="generate-btn" type="submit">
              <span class="btn-label">Generate Session Plan</span>
            </button>
            <div class="help-text" style="text-align: center;">AI creates a 50-minute structured plan with interventions, prompts, homework, and clinical rationale.</div>
          </div>
        </form>
      </div>

      <aside class="sidebar-section">
        <div class="sidebar-title">Quick Templates</div>
        <div class="sidebar-subtitle">Click to auto-fill the form</div>
        <ul class="template-list">
          <li class="template-item" data-topic="Adolescent experiencing school avoidance and social anxiety (teen, in-person)" data-modality="DBT">
            <div class="template-topic">School avoidance & social anxiety</div>
            <div class="template-modality">DBT • Adolescent</div>
          </li>
          <li class="template-item" data-topic="Adult client with post-breakup rumination and low mood (individual, telehealth)" data-modality="CBT">
            <div class="template-topic">Post-breakup rumination</div>
            <div class="template-modality">CBT • Adult</div>
          </li>
          <li class="template-item" data-topic="Values clarification work after job loss and identity crisis (adult, in-person)" data-modality="ACT">
            <div class="template-topic">Values work after job loss</div>
            <div class="template-modality">ACT • Adult</div>
          </li>
          <li class="template-item" data-topic="Child with trauma symptoms from witnessing domestic violence (age 8, play therapy)" data-modality="TF-CBT">
            <div class="template-topic">Childhood trauma processing</div>
            <div class="template-modality">TF-CBT • Child</div>
          </li>
          <li class="template-item" data-topic="Couple experiencing communication breakdown and recurring conflict (relationship therapy)" data-modality="EFT">
            <div class="template-topic">Couple communication issues</div>
            <div class="template-modality">EFT • Couples</div>
          </li>
        </ul>
      </aside>
    </div>

    {% if plan %}
    <section class="result-section">
      <div class="toolbar">
        <button id="copy-btn" class="toolbar-btn">📋 Copy to Clipboard</button>
        <button id="export-pdf-btn" class="toolbar-btn">📄 Export PDF</button>
        <button id="export-dap-btn" class="toolbar-btn">📝 Export as DAP</button>
        <button id="export-soap-btn" class="toolbar-btn">📊 Export as SOAP</button>
        <button id="regen-btn" class="toolbar-btn">🔄 Regenerate</button>
      </div>
      <div id="plan-render" class="plan-content">{{ plan|safe }}</div>
    </section>
    {% endif %}
  </main>

<script>
  // Tone selector
  const toneInput = document.getElementById('tone');
  const toneBtns = document.querySelectorAll('.tone-btn');
  
  toneBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      toneBtns.forEach(b => b.setAttribute('aria-pressed', 'false'));
      btn.setAttribute('aria-pressed', 'true');
      toneInput.value = btn.dataset.tone;
    });
  });

  // Template quick fill
  document.querySelectorAll('.template-item').forEach(item => {
    item.addEventListener('click', () => {
      document.getElementById('topic').value = item.dataset.topic;
      document.getElementById('modality').value = item.dataset.modality;
      document.getElementById('topic').focus();
    });
  });

  // Form submission
  const form = document.getElementById('generator-form');
  const genBtn = document.getElementById('generate-btn');
  const labelSpan = genBtn.querySelector('.btn-label');
  const originalLabel = labelSpan.textContent;
  
  form.addEventListener('submit', () => {
    genBtn.disabled = true;
    labelSpan.innerHTML = '<span class="spinner"></span>Generating your plan...';
    setTimeout(() => {
      genBtn.disabled = false;
      labelSpan.textContent = originalLabel;
    }, 20000);
  });

  // Utility: Flash feedback
  function flash(el, msg) {
    if (!el) return;
    const prev = el.textContent;
    el.textContent = msg;
    setTimeout(() => el.textContent = prev, 1500);
  }

  // Copy to clipboard
  document.getElementById('copy-btn')?.addEventListener('click', async () => {
    const planRender = document.getElementById('plan-render');
    const html = planRender?.innerHTML.trim() || '';
    if (!html) return;
    
    try {
      await navigator.clipboard.writeText(html);
      flash(document.getElementById('copy-btn'), '✓ Copied!');
    } catch (err) {
      alert('Could not copy to clipboard');
    }
  });

  // Export functions
  ['pdf', 'dap', 'soap'].forEach(type => {
    document.getElementById(`export-${type}-btn`)?.addEventListener('click', () => exportDoc(type));
  });

  function exportDoc(type) {
    const planRender = document.getElementById('plan-render');
    const html = planRender?.innerHTML || '';
    const fd = new FormData();
    fd.append('type', type);
    fd.append('html', html);
    
    fetch(`/export/${type}`, { method: 'POST', body: fd })
      .then(r => r.ok ? r.blob() : Promise.reject())
      .then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `session_${type}_${Date.now()}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      })
      .catch(() => {
        alert('Export failed. Please try again.');
      });
  }

  // Regenerate
  document.getElementById('regen-btn')?.addEventListener('click', () => {
    if (!confirm('Generate a new plan with the same settings?')) return;
    const hid = document.createElement('input');
    hid.type = 'hidden';
    hid.name = 'regen';
    hid.value = 'true';
    form.appendChild(hid);
    form.submit();
  });
</script>
</body>
</html>